<html>
  <header>
    <meta charset="utf-8">
    <title>Meu Primeiro Jogo Multiplayer</title>

    <style>
      #screen {
        border: 10px solid #CCC;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -moz-crisp-edges;
        width: 400px;
        height: 400px;
      }
    </style>
  </header>
  <body>
    <canvas id="screen" width="10" height="10"></canvas>

    <script>
      const context = document.getElementById('screen').getContext('2d');
      let currentPlayerId = 0;

      const createGame = () => {
        const state = {
          players: [
            { name: 'player1', x: 1, y: 2 },
            { name: 'player2', x: 9, y: 9 },
          ],
          fruits: [
            { name: 'fruit1', x: 3, y: 2 }
          ],
        };

        const movePlayer = (command) => {
          const { playerId, keyPressed } = command;
          const player = state.players[playerId];

          console.log(`Moving ${player.name} with ${keyPressed}`);
          
          if (keyPressed === 'ArrowUp') {
            return player.y = player.y === 0 ? 9 : player.y - 1;
          }

          if (keyPressed === 'ArrowDown') {
            return player.y = player.y === 9 ? 0 : player.y + 1;
          }

          if (keyPressed === 'ArrowLeft') {
            return player.x = player.x === 0 ? 9 : player.x - 1;
          }

          if (keyPressed === 'ArrowRight') {
            return player.x = player.x === 9 ? 0 : player.x + 1;
          }
        }

        return {
          movePlayer,
          state
        };
      }

      const createKeyboardListener = () => {
        const state = {
          observers: [],
        };

        const subscribe = (observerFunction) => state.observers.push(observerFunction);

        const notifyAll = (command) => {
          console.log(`Notifying ${state.observers.length} observers`);

          state.observers.map(observerFunction => observerFunction(command));
        }

        document.addEventListener('keydown', (event) => {
          const playerId = currentPlayerId;
          const keyPressed = event.key;

          notifyAll({ playerId, keyPressed });
        });

        return {
          subscribe,
        };
      }

      const game = createGame();
      const keyboardListener = createKeyboardListener();

      const renderItem = (color, positionX, positionY) => {
        context.fillStyle = color;
        context.fillRect(positionX, positionY, 1, 1);
      }

      const renderScreen = () => {
        context.fillStyle = 'white';
        context.fillRect(0, 0, 10, 10);

        game.state.players.map(player => renderItem('black', player.x, player.y));

        game.state.fruits.map(fruit => renderItem('green', fruit.x, fruit.y));

        requestAnimationFrame(renderScreen);
      }

      renderScreen();

      keyboardListener.subscribe(game.movePlayer);
    </script>
  </body>
</html>